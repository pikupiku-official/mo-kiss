# アーキテクチャ設計（To‑Be）

本書は **ゲーム本体の実行モデルと遷移の考え方** を示す。  
「理想状態（To‑Be）の具体化」を目的とし、未確定は `TBD` とする。

## 目的
- モジュール構成（Base State / Overlay）を明確にする
- 遷移が「非線形」であることを前提に設計指針を示す
- セーブ/ロードやOPTIONの扱いを定義する

---

## 用語
- **Base State**: TITLE / MAIN_MENU / HOME / DIALOGUE / MAP  
  画面とゲーム状態の核となるモジュール。
- **Overlay**: Base State の上に開く画面。ここでは OPTION。
- **Event**: DIALOGUE を起動するストーリー単位（例: `events/E001.ks`）。  
  DIALOGUEの入口条件として使われる。

---

## 実行モデル（全体像）
Entry: main.py
└─ Base State
├─ TITLE
├─ MAIN_MENU
├─ HOME
├─ DIALOGUE
└─ MAP
└─ Overlay
└─ OPTION（ポーズ、BGM継続、即時反映）

---

## Base State の役割（要約）

| State | 役割 | 典型入口 | 典型出口 | セーブ可否 |
|---|---|---|---|---|
| TITLE | 起動画面 | アプリ起動 | MAIN_MENU | なし |
| MAIN_MENU | はじめから/つづきから/設定等 | TITLE | HOME / LOAD | なし |
| HOME | 自宅シーン | MAIN_MENU / 帰宅 | MAP / DIALOGUE | 可能 |
| DIALOGUE | 物語進行 | MAP / HOME / EVENT | MAP / HOME | TBD |
| MAP | イベント選択 | HOME / DIALOGUE | DIALOGUE / HOME | 可能 |

---

## 遷移の原則（非線形を許容）
- **固定**: `TITLE -> MAIN_MENU` のみ
- それ以外は**状況依存**・**イベント依存**で構成される  
  （一本道ではない）

### 典型的な流れ（例）
- **起動**: TITLE → MAIN_MENU  
- **新規開始**: MAIN_MENU → HOME  
- **日中ループ**: DIALOGUE ↔ MAP  
- **帰宅**: DIALOGUE → HOME  
- **朝の出発**: HOME → DIALOGUE（登校イベント） or HOME → MAP  
- **ロード**: 保存時の状態へ復帰

※ これは**固定の遷移表ではない**。  
具体的な条件はイベント設計で定義する。

---

## OPTION（Overlay）
### 位置づけ
- HOME / DIALOGUE / MAP 上でいつでも開く
- **ポーズ扱い**だが **BGMは継続**
- 設定は **即時反映**

### 想定項目（現時点）
- 音量
- キーコンフィグ
- 表示
- テキスト速度
- スキップ
- メインメニューに戻る
- セーブ / ロード
- その他 `TBD`

### 非対象
- TITLE / MAIN_MENU では開かない方針

---

## セーブ / ロード方針
- **セーブ可能**: HOME / MAP  
- **DIALOGUE**: `TBD`（中断復帰を許すか検討）
- **ロード**: 保存時の状態へ復帰
- **オートセーブ**: なし
- **スロット**: 別世界線として複数保持
- **プレイヤー名**:  
  - 「はじめから」選択時に決定  
  - そのスロット内では固定

---

## バックエンド状態カテゴリ（参考）
- 設定（OPTION）
- シナリオフラグ
- 時間/日付
- セーブ状態
- プレイヤー名

> 保存場所や責務は `設計_データとアセット.md` 側で詰める。

---

## 未決事項（TBD）
- DIALOGUE中のセーブ/復帰仕様
- OPTIONの追加項目
- MAPでイベントが無い時の時間スキップ仕様
- 設定データの保存場所と形式

---

## 補足
本書は「構造と遷移の骨格」を規定する。  
個別の機能仕様やデータ仕様は以下で補完する。

- `設計_システム.md`
- `設計_データとアセット.md`
- `ギャップ一覧.md`
