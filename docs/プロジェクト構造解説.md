# MoKiss プロジェクト構造解説

## 概要
MoKissはPythonとPygameを使用して開発されたビジュアルノベルゲームです。メインメニュー、マップシステム、対話システムの3つのモードを統合したゲームアプリケーションとして設計されています。

---

## プロジェクト構造

```
mo-kiss/
├── main.py                    # メインアプリケーション
├── config.py                  # 設定管理
├── bgm_manager.py            # BGM再生システム
├── se_manager.py             # 効果音再生システム
├── image_manager.py          # 画像読み込み・管理システム
├── run_dialogue_only.py      # 対話テスト用単体起動
├── usage.py                  # 使用法説明
├── test_branching_system.py  # 分岐システムテスト
├── dialogue.ks               # メイン対話スクリプト
├── character_gender.json     # キャラクター性別設定
├── player_name.json          # プレイヤー名設定
├── dialogue/                 # 対話システム
├── menu/                     # メインメニューシステム
├── map/                      # マップシステム
├── events/                   # イベントデータ
├── images/                   # 画像リソース
├── sounds/                   # 音声リソース
├── fonts/                    # フォントリソース
└── docs/                     # ドキュメント
```

---

## 主要ファイルの役割

### 1. **main.py** - メインアプリケーション
**役割：** ゲーム全体の制御と3つのモード（メニュー、マップ、対話）の統合管理

**主要クラス：**
- `GameApplication` - ゲームアプリケーションのメインクラス

**重要メソッド：**
- `run()` - メインゲームループの実行
- `switch_to_menu/map/dialogue()` - モード切り替え処理
- `handle_*_events()` - 各モードのイベント処理
- `update()` - ゲーム状態の更新
- `render()` - 画面描画

**特徴：**
- 30FPSでの最適化されたフレームレート制御
- モード切り替え時の安全な状態管理
- 全画面表示対応

### 2. **config.py** - 設定管理システム
**役割：** 画面解像度、スケーリング、UI配置の統一管理

**主要機能：**
- **解像度システム：** 仮想解像度1920x1080を基準とした自動スケーリング
- **PyQt5連携：** 実際のディスプレイサイズ取得
- **UI配置計算：** テキストボックス、ボタンの位置計算
- **キャラクター設定：** 性別データ、まばたき設定

**重要関数：**
- `init_game()` - Pygame初期化とフルスクリーン設定
- `scale_pos()` - 仮想座標を実座標にスケーリング
- `get_text_positions()` - テキスト表示位置計算

### 3. **bgm_manager.py** - BGM再生システム
**役割：** バックグラウンドミュージックの再生、フェード効果、一時停止管理

**主要クラス：**
- `BGMManager` - BGM制御のメインクラス

**主要機能：**
- **ファイル管理：** sounds/bgms/ 内の音楽ファイル自動検出
- **フェード効果：** イージング関数を使用した滑らかなフェードイン/アウト
- **非同期処理：** ThreadPoolExecutorによる非ブロッキング再生
- **一時停止機能：** フェード付き一時停止・再開

**対応形式：** MP3, WAV, OGG, M4A

### 4. **se_manager.py** - 効果音再生システム
**役割：** 効果音の再生とキャッシュ管理

**主要クラス：**
- `SEManager` - 効果音制御クラス

**主要機能：**
- **キャッシュシステム：** 最大20個のSEファイルをメモリキャッシュ
- **連続再生：** frequency パラメータによる複数回再生
- **非同期対応：** asyncio を使用した非同期再生
- **ファイル管理：** sounds/ses/ 内の効果音自動検出

### 5. **image_manager.py** - 画像管理システム
**役割：** 画像の読み込み、キャッシュ、遅延ロード管理

**主要クラス：**
- `ImageManager` - 画像管理のメインクラス

**主要機能：**
- **LRUキャッシュ：** 最大50個の画像をメモリ効率的に管理
- **遅延ロード：** 必要時に画像を読み込む最適化システム
- **非同期処理：** ThreadPoolExecutor による並列画像読み込み
- **自動スケーリング：** 画像タイプ別の最適サイズ自動調整
- **スレッドセーフ：** マルチスレッド環境での安全な操作

**対応形式：** PNG, JPG, JPEG, WEBP

### 6. **save_manager.py** - セーブ・ロード管理システム
**役割：** ゲーム状態の保存・読み込み、セーブスロット管理

**主要クラス：**
- `SaveManager` - セーブシステムのメインクラス

**主要機能：**
- **セーブスロット管理：** 最大10個のセーブスロット
- **状態ファイル管理：** プレイヤー名、時間状態、イベント進行の保存
- **テンプレート機能：** 新規データ作成時のテンプレート適用
- **バックアップ機能：** データの安全な復元

**管理ファイル：**
- `completed_events.csv` - イベント完了状況
- `time_state.json` - ゲーム内時間状態
- `player_name.json` - プレイヤー名情報

### 7. **time_manager.py** - 時間帯・日付管理システム
**役割：** ゲーム内時間の管理、時間帯の進行制御

**主要クラス：**
- `TimeManager` - 時間管理のメインクラス

**主要機能：**
- **時間帯管理：** 朝・昼・放課後・夜の4つの時間帯
- **日付進行：** 年月日、曜日の自動計算
- **状態保存：** 時間状態の永続化
- **時間進行制御：** 時間帯の手動・自動進行

**対応時間帯：** 朝、昼、放課後、夜

### 8. **title_screen.py** - タイトル画面システム
**役割：** ゲーム起動時のタイトル画面表示

**主要クラス：**
- `TitleScreen` - タイトル画面のメインクラス

**主要機能：**
- **背景画像表示：** タイトル背景の読み込み・表示
- **点滅効果：** タイトルテキストの点滅演出
- **BGM制御：** タイトル用BGMの再生
- **レスポンシブ対応：** 解像度に応じた自動スケーリング

### 9. **home.py** - ホーム画面システム
**役割：** メインゲーム画面の表示・制御

---

## サブシステム詳細

### dialogue/ - 対話システム
ビジュアルノベルのメイン機能を担当する包括的なシステム

#### **controller2.py** - 対話制御
- pygame イベント処理（マウス、キーボード）
- 選択肢判定とテキスト進行制御
- 自動進行・スキップモードの管理

#### **model.py** - システム統合
- 各種マネージャーの機能統合（ファサードパターン）
- バージョン管理とモジュール情報提供

#### **text_renderer.py** - テキスト描画
- **26文字自動改行システム**
- **3行スクロール表示**
- まばたきアニメーション連携
- 変数置換システム（プレイヤー名など）
- 句読点での遅延制御

#### **character_manager.py** - キャラクター管理
- キャラクター移動アニメーション
- 顔パーツ描画（目、口、眉、頬の合成）
- **自動まばたきシステム**（2-5秒間隔）
- 画像スケーリングキャッシュ

#### **background_manager.py** - 背景管理
- 背景表示、移動、ズームアニメーション
- 仮想解像度システム対応
- 背景スケーリングキャッシュ

#### **choice_renderer.py** - 選択肢システム
- 選択肢表示とマウスハイライト
- 変数置換対応選択肢テキスト
- クリック判定処理

#### **scenario_manager.py** - シナリオ制御
- 対話進行のメイン処理
- 各種コマンド処理（キャラクター操作、背景制御、音声制御）
- フェード効果制御

#### **data_normalizer.py** - データ正規化
- dialogue_loader の辞書データを統一形式に変換
- キャラクター名変換（桃子→T04_00_00など）

#### **dialogue_loader.py** - .ks ファイル解析
- ビジュアルノベル用スクリプト（.ks）の解析
- ストーリーフラグ管理
- 非同期ファイル読み込み

#### **notification_manager.py** - 通知システム
- イベント解禁時の通知表示
- システムメッセージの管理
- ユーザーへのフィードバック制御

#### **date_manager.py** - 日付表示管理
- ゲーム内日付の表示制御
- 時間情報の表示フォーマット

#### **fade_manager.py** - フェード効果管理
- 画面フェードイン・アウト効果
- シーン切り替え時の視覚効果

#### **backlog_manager.py** - バックログ機能
- 会話履歴の管理
- 過去の会話内容の表示

#### **scroll_manager.py** - スクロール制御
- テキストスクロール効果
- 表示速度の制御

#### **text_renderer_patch.py** - テキスト描画パッチ
- テキスト描画の拡張機能
- 特殊効果の追加実装

#### **game_manager.py** - ゲーム管理
- ゲーム全体の状態管理
- システム統合制御

**対応タグ：**
```
[bg], [bg_show], [bg_move]     # 背景制御
[chara_show], [chara_move], [chara_hide]  # キャラクター制御
[BGM], [BGMSTOP], [BGMSTART]   # BGM制御
[SE]                           # SE制御
[choice]                       # 選択肢
[fadeout], [fadein]           # フェード効果
[scroll-stop]                 # スクロール停止
[event_unlock]                # イベント解禁
[time_advance]                # 時間進行
「」                          # 対話テキスト
```

### menu/ - メインメニューシステム
- **main_menu.py** - メインメニューの表示と操作
- **main_menu_config.py** - メニュー設定
- **ui_components.py** - UI部品

**新機能：**
- **セーブ・ロード機能：** メインメニューからのセーブ・ロード操作
- **セーブスロット選択：** 複数スロットでの保存・読み込み
- **状態表示：** セーブデータの詳細情報表示

### map/ - マップシステム
- **map.py** - メインマップクラス
- **map_characters.py** - マップ上のキャラクター管理
- **map_config.py** - マップ設定
- **map_events.py** - マップイベント処理
- **map_renderer.py** - マップ描画

---

## データファイル・フォルダ

### 設定ファイル
- **character_gender.json** - キャラクター性別設定
  ```json
  {
    "桃子": "female",
    "サナコ": "female",
    "ますた": "male"
  }
  ```

- **player_name.json** - プレイヤー名設定
  ```json
  {
    "surname": "久保田",
    "name": "航輝"
  }
  ```

### events/ - イベントデータ
- **events.csv** - 66個のイベント情報（日時、場所、対象ヒロイン）
- **completed_events.csv** - 完了イベント記録
- **story_flags.json** - ストーリー進行フラグ
- **E001.ks ～ E066.ks** - 各イベントの対話スクリプト
- **event_base.py** - イベント基底クラス

### リソースフォルダ

#### images/ - 画像リソース
```
images/
├── backgrounds/          # 背景画像
├── icons/               # キャラクターアイコン
├── 桃子/                # キャラクター画像セット
│   ├── characters/      # メイン体画像
│   ├── eyes/           # 目画像
│   ├── mouths/         # 口画像
│   ├── brows/          # 眉画像
│   └── cheeks/         # 頬画像
└── ui*.png             # UI要素
```

#### sounds/ - 音声リソース
```
sounds/
├── bgms/               # バックグラウンドミュージック
└── ses/                # 効果音
```

#### fonts/ - フォントファイル
- **M PLUS Rounded 1c** フォントファミリー（7種類のウェイト）
- 日本語対応ゲーム用フォント

### scripts/ - ユーティリティスクリプト
新しく追加されたスクリプト群：

- **initialize_completed_events.py** - 完了イベントデータの初期化
- **restore_events_csv.py** - イベントCSVファイルの復元

### テストファイル
- **test_save_system.py** - セーブシステムの機能テスト
- **test_branching_system.py** - 分岐システムテスト

---

## 技術的特徴

### パフォーマンス最適化
- **遅延ロード：** 画像の必要時読み込み
- **LRUキャッシュ：** メモリ効率的なリソース管理
- **非同期処理：** ThreadPoolExecutor、asyncio活用
- **フレームレート制御：** 30FPS最適化

### スケーラブル設計
- **仮想解像度システム：** 1920x1080基準の自動スケーリング
- **モジュラー構造：** 各システムの独立性維持
- **設定外部化：** JSON、CSVによる柔軟な設定管理

### ビジュアルノベル専用機能
- **26文字自動改行**
- **3行スクロール表示**
- **自動まばたきシステム**
- **顔パーツ合成**
- **フェード効果**
- **選択肢分岐**
- **変数置換システム**
- **セーブ・ロード機能**
- **時間帯進行システム**
- **イベント解禁通知**

### 対応形式
- **画像：** PNG, JPG, JPEG, WEBP
- **音声：** MP3, WAV, OGG, M4A
- **スクリプト：** .ks（独自形式）
- **データ：** JSON, CSV

---

## 使用技術スタック

- **Python 3.x**
- **Pygame** - ゲームエンジン
- **PyQt5** - システム情報取得
- **asyncio** - 非同期処理
- **threading** - マルチスレッド処理
- **JSON/CSV** - データ管理

このシステムは、パフォーマンスと機能性を両立させたビジュアルノベルエンジンとして設計されており、リソース管理、ユーザーエクスペリエンス、開発効率のすべてにおいて最適化されています。