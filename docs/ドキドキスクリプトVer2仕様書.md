# ドキドキスクリプトVer.2 仕様書

## 概要

ドキドキスクリプトVer.2は、ギャルゲー・ビジュアルノベルゲームの演出制御を行うスクリプト言語です。
キャラクターの表情・動作、背景の表示・切り替え、BGMの制御、テキスト表示、選択肢システム、フェード効果、条件分岐など、インタラクティブなストーリーテリングに必要な機能を包括的にサポートします。

## 基本構文

### コメント記法
```
;----------------------------------------------
;◆メインシナリオ
;----------------------------------------------
```

### 話者の指定
```
//キャラクター名//
```
これ以降のセリフは指定されたキャラクターのものとして扱われます。

### セリフの記述
```
「セリフの内容」
```
日本語のカギカッコでセリフを囲みます。26文字で自動改行され、行数が自動計算されます。

## 背景制御

### 背景の設定・表示
```
[bg_show storage="背景ファイル名" bg_x="0.5" bg_y="0.5" bg_zoom="1.0"]
```

**パラメータ:**
- `storage`: 背景画像のファイル名
- `bg_x`: X座標（0.0-1.0、デフォルト: 0.5）
- `bg_y`: Y座標（0.0-1.0、デフォルト: 0.5）  
- `bg_zoom`: ズーム倍率（デフォルト: 1.0）

### 背景の移動・ズーム
```
[bg_move storage="背景ファイル名" bg_left="0.1" bg_top="0.1" time="1000" bg_zoom="1.5"]
```

**パラメータ:**
- `storage` または `sub`: 背景画像のファイル名
- `bg_left`: 移動先X座標
- `bg_top`: 移動先Y座標
- `time`: アニメーション時間（ミリ秒、デフォルト: 600）
- `bg_zoom`: ズーム倍率（デフォルト: 1.0）

## キャラクター制御

### 論理名と胴体IDについて

キャラクター管理には2つの概念があります：

- **論理名（name）**: キャラクターを識別する名前（例: `"桃子"`、`"サナコ"`）。すべてのキャラクター操作で統一して使用します。
- **胴体ID（torso）**: キャラクター画像ファイルの識別子（例: `"T03_00_01"`）。`chara_show`でのみ指定します。

**重要**: `chara_move`と`chara_hide`では必ず論理名（`name`）を使用してください。胴体IDを使用すると、キャラクターが見つからずエラーになります。

### キャラクターの表示
```
[chara_show name="桃子" torso="T03_00_01" eye="目の表情" mouth="口の表情" brow="眉の表情" cheek="頬の表情" x="0.5" y="0.5" size="1.0" blink="true"]
```

**パラメータ:**
- `name`: キャラクターの論理名（必須）
- `torso`: 胴体画像のファイル識別子（省略時は`name`の値を使用）
- `eye`: 目の表情パーツファイル名
- `mouth`: 口の表情パーツファイル名
- `brow`: 眉の表情パーツファイル名
- `cheek`: 頬の表情パーツファイル名（省略可）
- `x`: X座標（0.0-1.0、デフォルト: 0.5）
- `y`: Y座標（0.0-1.0、デフォルト: 0.5）
- `size`: サイズ倍率（デフォルト: 1.0）
- `blink`: まばたきの有効/無効（デフォルト: true）

### キャラクターの移動
```
[chara_move name="桃子" time="600" left="0.1" top="0.02" zoom="1.0"]
```

**パラメータ:**
- `name`: 移動対象のキャラクター論理名（必須）
- `time`: アニメーション時間（ミリ秒、デフォルト: 600）
- `left`: 移動量X（相対値）
- `top`: 移動量Y（相対値）
- `zoom`: サイズ倍率（省略可）

### キャラクターの退場
```
[chara_hide name="桃子"]
```

**パラメータ:**
- `name`: 退場させるキャラクターの論理名（必須）

## BGM・音声制御

### BGMの再生
```
[BGM bgm="音楽ファイル名" volume="0.5" loop="true"]
```

**パラメータ:**
- `bgm`: 音楽ファイル名
- `volume`: 音量（0.0-1.0、デフォルト: 設定値）
- `loop`: ループ再生（true/false、デフォルト: 設定値）

**特殊値:**
- `"school"`: 初期BGMなし
- `"classroom"`: 第2BGMファイル


### BGMの一時停止と再生
```
[BGMSTOP time="5"]
[BGMSTART time="5"]
```

**パラメータ:**
- `time`: フェード時間

### SEの再生
```
[SE se="SEファイル名" volume="0.5" frequency="1"]
```

**パラメータ:**
- `se`: SEファイル名
- `volume`: 音量（0.0-1.0、デフォルト: 設定値）
- `frequency`: 連続再生回数

## 選択肢システム

### 選択肢の表示
```
[choice option1="選択肢1" option2="選択肢2" option3="選択肢3"]
```

**パラメータ:**
- `option1`, `option2`, `option3`: 各選択肢のテキスト
- 最低2つの選択肢が必要

## フェード効果

### フェードアウト
```
[fadeout color="black" time="1.0"]
```

**パラメータ:**
- `color`: フェード色（デフォルト: "black"）
- `time`: フェード時間（秒、デフォルト: 1.0）

### フェードイン
```
[fadein time="1.5"]
```

**パラメータ:**
- `time`: フェード時間（秒、デフォルト: 1.0）

## スクロール制御

### スクロール継続の停止
```
[scroll-stop]
```
テキストのスクロール表示を停止し、クリック待ちにします。

**セリフ内での使用:**
```
「テキストの内容」[scroll-stop]
```

## 条件分岐・フラグシステム

### フラグの設定
```
[flag_set name="フラグ名" value="値"]
```

**パラメータ:**
- `name`: フラグ名
- `value`: 設定値（文字列、数値、true/false）

### 条件分岐
```
[if condition="条件式"]
    条件が真の場合に実行される内容
[endif]
```

**条件式の例:**
- `"フラグ名==true"`
- `"aggressive_approach==false"`
- `"count==5"`

**論理演算子:**
- `AND`: 論理積
- `OR`: 論理和

例: `"flag1==true AND flag2==false"`

## イベント制御

### イベントの有効化・無効化
```
[event_unlock target="イベント1,イベント2" lock="イベント3,イベント4"]
```

**パラメータ:**
- `target`: 有効化するイベントIDのカンマ区切りリスト
- `lock`: 無効化するイベントIDのカンマ区切りリスト

## 特殊機能

### 自動改行
テキストは26文字で自動改行されます。この設定は`set_max_chars_per_line()`で変更可能です。

### キャラクター表情の継承
キャラクターの表情パーツは一度設定されると、次に明示的に変更されるまで保持されます。

### スクロール表示
`[scroll-stop]`が指定されるまで、連続するテキストはスクロール表示されます。

## ファイル形式

- 拡張子: `.ks`
- エンコーディング: UTF-8
- 改行コード: LF または CRLF

## サンプルコード

```kag
*scene1
;----------------------------------------------
;◆オープニングシーン
;----------------------------------------------

[bg_show storage="test.bg.school" bg_x="0.5" bg_y="0.5" bg_zoom="1.0"]
[BGM bgm="03 Hizashi.mp3" volume="0.5" loop="true"]

; キャラクター登場（論理名="桃子"、胴体ID="T03_00_00"）
[chara_show name="桃子" torso="T03_00_00" eye="F03_En00_00" mouth="F03_Mn00_00" brow="F03_Bn00_00" x="0.5" y="0.5" size="1.5" blink="true"]

//桃子//
「おはよう！」
「今日もいい天気だね」[scroll-stop]

; キャラクター移動（論理名で指定）
[chara_move name="桃子" time="500" left="-0.2" top="0" zoom="1.2"]

[choice option1="そうだね" option2="曇ってるよ"]

[flag_set name="morning_greeting" value="true"]

[if condition="morning_greeting==true"]
    //桃子//
    「ありがとう！」
[endif]

; キャラクター退場（論理名で指定）
[chara_hide name="桃子"]

[fadeout color="black" time="2.0"]
[fadein time="1.5"]

*scene2
;----------------------------------------------
;◆次のシーン
;----------------------------------------------
```

## 注意事項

1. キャラクター画像ファイルは事前に用意する必要があります
2. BGMファイルは対応する形式（.ogg, .mp3等）で準備してください  
3. 背景画像は適切な解像度で用意してください
4. フラグ名やイベントIDは英数字推奨です
5. 座標値は0.0-1.0の範囲で指定します（画面の相対位置）

## 実装詳細

このスクリプトは`dialogue_loader.py`の`DialogueLoader`クラスによって解析・実行されます。詳細な実装については該当ファイルを参照してください。