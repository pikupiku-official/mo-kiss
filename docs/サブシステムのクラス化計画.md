# ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¯ãƒ©ã‚¹åŒ–è¨ˆç”»

## ç›®çš„

ç¾åœ¨ã€ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ é–“ã®é·ç§»æ™‚ã«éŸ³å£°ï¼ˆBGMãƒ»SEï¼‰ã‚’åœæ­¢ã™ã‚‹å‡¦ç†ãŒã€å„`switch_to_*`ãƒ¡ã‚½ãƒƒãƒ‰ã«é‡è¤‡ã—ã¦è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã€‚ã“ã®è¨­è¨ˆã¯ä¿å®ˆæ€§ãŒä½ãã€æ–°ã—ã„ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹éš›ã«çµ„ã¿åˆã‚ã›çˆ†ç™ºã‚’èµ·ã“ã™ã€‚

æœ¬è¨ˆç”»ã§ã¯ã€å…¨ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã«çµ±ä¸€ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒãŸã›ã‚‹ã“ã¨ã§ã€ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã€‚

---

## ç¾åœ¨ã®å•é¡Œç‚¹

### å•é¡Œ1: çµ„ã¿åˆã‚ã›çˆ†ç™º

```python
# ç¾çŠ¶: å„switch_to_*ã«å…¨ã¦ã®é·ç§»å…ƒã‚’ãƒã‚§ãƒƒã‚¯
def switch_to_menu():
    if current_mode == "dialogue": dialogueåœæ­¢å‡¦ç†
    if current_mode == "map": mapåœæ­¢å‡¦ç†
    # å°†æ¥homeã‚„titleãŒéŸ³ã‚’æŒã£ãŸã‚‰...ã•ã‚‰ã«å¢—ãˆã‚‹

def switch_to_home():
    if current_mode == "dialogue": dialogueåœæ­¢å‡¦ç†
    if current_mode == "map": mapåœæ­¢å‡¦ç†
    # ...åŒã˜å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã—
```

**å•é¡Œç‚¹:**
- ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ãŒNå€‹ã‚ã‚‹ã¨ã€NÃ—Nã®çµ„ã¿åˆã‚ã›ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹
- ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ãŒå¤šã„
- æ–°ã—ã„ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ æ™‚ã®ä¿®æ­£ç®‡æ‰€ãŒå¤šã„
- ãƒã‚°ãŒæ··å…¥ã—ã‚„ã™ã„

### å•é¡Œ2: è²¬ä»»ã®æ‰€åœ¨ãŒä¸æ˜ç¢º

å„ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªåˆ†ã®çµ‚äº†å‡¦ç†ã‚’çŸ¥ã‚‰ãšã€main.pyãŒå…¨ã¦æŠŠæ¡ã—ã¦ã„ã‚‹çŠ¶æ…‹ã€‚

### å•é¡Œ3: çµ±ä¸€ã•ã‚ŒãŸãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãŒãªã„

- åˆæœŸåŒ–: ãƒãƒ©ãƒãƒ©ï¼ˆã‚¯ãƒ©ã‚¹ã€é–¢æ•°ã€è¾æ›¸...ï¼‰
- ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†: `handle_events`, `handle_event` ãªã©åå‰ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„
- æ›´æ–°: `update` ã¯ã‚ã‚‹ãŒã€ä½¿ã„æ–¹ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„
- æç”»: `render` ã¯ã‚ã‚‹ãŒã€å‘¼ã³å‡ºã—æ–¹ãŒãƒãƒ©ãƒãƒ©
- çµ‚äº†: cleanupå‡¦ç†ãŒå­˜åœ¨ã—ãªã„

---

## ç›®æ¨™ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### çµ±ä¸€ã•ã‚ŒãŸåŸºåº•ã‚¯ãƒ©ã‚¹

```python
# subsystem_base.pyï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
from abc import ABC, abstractmethod
import pygame

class SubsystemBase(ABC):
    """å…¨ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®åŸºåº•ã‚¯ãƒ©ã‚¹"""

    def __init__(self, screen: pygame.Surface):
        self.screen = screen

    @abstractmethod
    def handle_events(self, events) -> str | None:
        """
        ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†

        Returns:
            str | None: é·ç§»å…ˆï¼ˆä¾‹: "go_to_map", "go_to_menu"ï¼‰
                       Noneã®å ´åˆã¯é·ç§»ã—ãªã„
        """
        pass

    @abstractmethod
    def update(self):
        """ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯æ›´æ–°"""
        pass

    @abstractmethod
    def render(self):
        """ç”»é¢æç”»"""
        pass

    def cleanup(self):
        """
        ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ çµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä½•ã‚‚ã—ãªã„
        """
        pass

    def on_enter(self):
        """
        ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã«å…¥ã£ãŸæ™‚ã®å‡¦ç†ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰
        ä¾‹ï¼šBGMå†ç”Ÿé–‹å§‹ã€åˆæœŸåŒ–ãªã©
        """
        pass
```

### main.pyã§ã®çµ±ä¸€ã•ã‚ŒãŸåˆ‡ã‚Šæ›¿ãˆå‡¦ç†

```python
class GameApplication:
    def switch_to(self, subsystem: SubsystemBase, mode_name: str):
        """ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ åˆ‡ã‚Šæ›¿ãˆã®çµ±ä¸€ãƒ¡ã‚½ãƒƒãƒ‰"""

        # 1. ç¾åœ¨ã®ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if self.current_subsystem:
            self.current_subsystem.cleanup()
            print(f"ğŸ”‡ {self.current_mode} cleanupå®Œäº†")

        # 2. æ–°ã—ã„ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ
        self.current_subsystem = subsystem
        self.current_mode = mode_name

        # 3. æ–°ã—ã„ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–å‡¦ç†
        self.current_subsystem.on_enter()
        print(f"âœ… {mode_name} ã«åˆ‡ã‚Šæ›¿ãˆ")
```

---

## æ®µéšçš„ãªç§»è¡Œè¨ˆç”»

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºåº•ã‚¯ãƒ©ã‚¹ä½œæˆã¨ç°¡å˜ãªã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰

**å®Ÿæ–½å†…å®¹:**
1. `subsystem_base.py` ã‚’ä½œæˆ
2. `menu/main_menu.py` ã® `MainMenu` ã‚’ `SubsystemBase` ã‹ã‚‰ç¶™æ‰¿
3. `home/home.py` ã® `HomeModule` ã‚’ `SubsystemBase` ã‹ã‚‰ç¶™æ‰¿

**ç†ç”±:**
- MainMenuã¨HomeModuleã¯æ—¢ã«ã‚¯ãƒ©ã‚¹åŒ–ã•ã‚Œã¦ã„ã‚‹
- éŸ³å£°ã‚’æŒãŸãªã„ã®ã§ã€cleanup()ã¯ç©ºå®Ÿè£…ã§OK
- ç°¡å˜ã«ç§»è¡Œã§ãã‚‹

**å¤‰æ›´ä¾‹ï¼ˆHomeModuleï¼‰:**
```python
# home/home.py
from subsystem_base import SubsystemBase

class HomeModule(SubsystemBase):
    def __init__(self, screen):
        super().__init__(screen)
        # æ—¢å­˜ã®åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰
        self._init_fonts()
        self.choices = [...]

    def handle_events(self, events) -> str | None:
        # æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ã»ã¼ãã®ã¾ã¾
        # æˆ»ã‚Šå€¤ã‚’ "go_to_map" ãªã©ã«çµ±ä¸€
        pass

    def update(self):
        # æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾
        pass

    def render(self):
        # æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾
        pass

    def cleanup(self):
        # ç¾åœ¨ã¯ä½•ã‚‚ã—ãªã„ï¼ˆå°†æ¥BGMã‚’è¿½åŠ ã—ãŸã‚‰ã“ã“ã«æ›¸ãï¼‰
        pass
```

**å®Œäº†æ¡ä»¶:**
- MainMenuã¨HomeModuleãŒSubsystemBaseã‚’ç¶™æ‰¿
- æ—¢å­˜æ©Ÿèƒ½ãŒå…¨ã¦å‹•ä½œã™ã‚‹
- ãƒ†ã‚¹ãƒˆãŒé€šã‚‹

---

### ãƒ•ã‚§ãƒ¼ã‚º2: mapã‚·ã‚¹ãƒ†ãƒ ã®ç§»è¡Œï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰

**å®Ÿæ–½å†…å®¹:**
1. `map/map.py` ã® `AdvancedKimikissMap` ã‚’ `SubsystemBase` ã‹ã‚‰ç¶™æ‰¿
2. `cleanup()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ï¼ˆBGMåœæ­¢å‡¦ç†ï¼‰
3. `on_enter()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ï¼ˆBGMå†ç”Ÿå‡¦ç†ï¼‰

**å¤‰æ›´ä¾‹:**
```python
# map/map.py
from subsystem_base import SubsystemBase

class AdvancedKimikissMap(SubsystemBase):
    def __init__(self, screen=None):
        if screen is None:
            screen = pygame.display.get_surface()

        super().__init__(screen)

        # æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†
        self.bgm_manager = BGMManager(debug=self.debug_mode)
        # ...

    def cleanup(self):
        """ãƒãƒƒãƒ—çµ‚äº†æ™‚ã®å‡¦ç†"""
        self.bgm_manager.stop_bgm()
        print("ğŸ”‡ map cleanup: BGMåœæ­¢")

    def on_enter(self):
        """ãƒãƒƒãƒ—ã«å…¥ã£ãŸæ™‚ã®å‡¦ç†"""
        self.update_bgm()  # BGMå†ç”Ÿ
        self.update_events()  # ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°
        print("ğŸµ map on_enter: BGMå†ç”Ÿ")
```

**å®Œäº†æ¡ä»¶:**
- AdvancedKimikissMapãŒSubsystemBaseã‚’ç¶™æ‰¿
- cleanup()ã§BGMãŒåœæ­¢ã™ã‚‹
- on_enter()ã§BGMãŒå†ç”Ÿã•ã‚Œã‚‹

---

### ãƒ•ã‚§ãƒ¼ã‚º3: dialogueã‚·ã‚¹ãƒ†ãƒ ã®ç§»è¡Œï¼ˆå„ªå…ˆåº¦ï¼šä¸­ï¼‰

dialogueã¯ç¾åœ¨**è¾æ›¸å½¢å¼ã®game_state**ãªã®ã§ã€2ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã‚ã‚‹ã€‚

#### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒA: ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹ï¼ˆæ¨å¥¨ï¼šæ®µéšçš„ç§»è¡Œï¼‰

**å®Ÿæ–½å†…å®¹:**
1. `dialogue/dialogue_subsystem.py` ã‚’æ–°è¦ä½œæˆ
2. `DialogueSubsystem` ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ï¼ˆãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
3. æ—¢å­˜ã®game_stateã‚’å†…éƒ¨ã§ä¿æŒ
4. controller2ã€modelã€scenario_managerã¯æ—¢å­˜ã®ã¾ã¾ä½¿ç”¨

**å¤‰æ›´ä¾‹:**
```python
# dialogue/dialogue_subsystem.pyï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
from subsystem_base import SubsystemBase
from dialogue.model import initialize_game as init_dialogue_game
from dialogue.controller2 import handle_events as dialogue_handle_events
from dialogue.controller2 import update_game as dialogue_update

class DialogueSubsystem(SubsystemBase):
    """dialogueã‚·ã‚¹ãƒ†ãƒ ã®ãƒ©ãƒƒãƒ‘ãƒ¼"""

    def __init__(self, screen, event_file=None):
        super().__init__(screen)

        # æ—¢å­˜ã®game_stateè¾æ›¸ã‚’å†…éƒ¨ã§ä¿æŒ
        self.game_state = init_dialogue_game()

        # ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
        if event_file:
            self._load_event_file(event_file)

    def _load_event_file(self, event_file):
        """ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿"""
        from dialogue.dialogue_loader import DialogueLoader
        from dialogue.data_normalizer import normalize_dialogue_data

        dialogue_loader = DialogueLoader()
        raw_dialogue_data = dialogue_loader.load_dialogue_from_ks(event_file)
        if raw_dialogue_data:
            dialogue_data = normalize_dialogue_data(raw_dialogue_data)
            if dialogue_data:
                self.game_state['dialogue_data'] = dialogue_data
                self.game_state['current_paragraph'] = -1
                from dialogue.model import advance_dialogue
                advance_dialogue(self.game_state)

    def handle_events(self, events) -> str | None:
        """dialogueã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†"""
        continue_dialogue = dialogue_handle_events(self.game_state, self.screen)

        if not continue_dialogue:
            return "dialogue_ended"

        return None

    def update(self):
        """dialogueã®æ›´æ–°"""
        dialogue_update(self.game_state)

    def render(self):
        """dialogueã®æç”»"""
        from dialogue.text_renderer import TextRenderer
        from dialogue.character_manager import draw_characters
        from dialogue.background_manager import draw_background
        from dialogue.choice_renderer import ChoiceRenderer
        from dialogue.fade_manager import draw_fade_overlay

        # èƒŒæ™¯æç”»
        draw_background(self.game_state)

        # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æç”»
        draw_characters(self.game_state)

        # ãƒ•ã‚§ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”»
        draw_fade_overlay(self.game_state)

        # UIã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆæç”»
        # ... æ—¢å­˜ã®æç”»ã‚³ãƒ¼ãƒ‰

    def cleanup(self):
        """dialogueçµ‚äº†æ™‚ã®å‡¦ç†"""
        self.game_state['bgm_manager'].stop_bgm()
        self.game_state['se_manager'].stop_all_se()
        print("ğŸ”‡ dialogue cleanup: BGMãƒ»SEåœæ­¢")
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- æ—¢å­˜ã®dialogueã‚³ãƒ¼ãƒ‰ã‚’ã»ã¼ãã®ã¾ã¾ä½¿ãˆã‚‹
- æ®µéšçš„ã«ç§»è¡Œã§ãã‚‹
- ãƒªã‚¹ã‚¯ãŒä½ã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒ©ãƒƒãƒ‘ãƒ¼ãŒå¢—ãˆã‚‹
- å®Œå…¨ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§ã¯ãªã„

**å®Œäº†æ¡ä»¶:**
- DialogueSubsystemã‚¯ãƒ©ã‚¹ãŒå‹•ä½œã™ã‚‹
- æ—¢å­˜ã®dialogueæ©Ÿèƒ½ãŒå…¨ã¦ä½¿ãˆã‚‹
- cleanup()ã§BGMãƒ»SEãŒåœæ­¢ã™ã‚‹

---

#### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒB: dialogueã‚’å®Œå…¨ã«ã‚¯ãƒ©ã‚¹åŒ–ï¼ˆå°†æ¥çš„ãªç†æƒ³å½¢ï¼‰

**å®Ÿæ–½å†…å®¹:**
1. game_stateè¾æ›¸ã‚’æ’é™¤
2. DialogueSubsystemã‚¯ãƒ©ã‚¹ãŒçŠ¶æ…‹ã‚’ç›´æ¥ä¿æŒ
3. controller2ã€scenario_managerãªã©ã‚’å…¨ã¦æ›¸ãæ›ãˆ

**å¤‰æ›´ä¾‹:**
```python
# dialogue/dialogue_subsystem.pyï¼ˆå®Œå…¨ã‚¯ãƒ©ã‚¹åŒ–ç‰ˆï¼‰
from subsystem_base import SubsystemBase
from bgm_manager import BGMManager
from se_manager import SEManager

class DialogueSubsystem(SubsystemBase):
    """dialogueã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨ã‚¯ãƒ©ã‚¹åŒ–ç‰ˆï¼‰"""

    def __init__(self, screen, event_file=None):
        super().__init__(screen)

        # ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ç›´æ¥ä¿æŒ
        self.bgm_manager = BGMManager(DEBUG)
        self.se_manager = SEManager(DEBUG)
        self.image_manager = ImageManager(DEBUG)
        self.text_renderer = TextRenderer(screen, DEBUG)
        # ... ä»–ã®ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼

        # çŠ¶æ…‹ã‚’ç›´æ¥ä¿æŒ
        self.dialogue_data = []
        self.current_paragraph = 0
        self.character_pos = {}
        # ... ä»–ã®çŠ¶æ…‹

        if event_file:
            self.load_event(event_file)

    def cleanup(self):
        """çµ‚äº†å‡¦ç†"""
        self.bgm_manager.stop_bgm()
        self.se_manager.stop_all_se()
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- å®Œå…¨ã«çµ±ä¸€ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- game_stateè¾æ›¸ãŒä¸è¦
- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘çš„ã«ç¾ã—ã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- å¤§è¦æ¨¡ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãŒå¿…è¦
- ãƒªã‚¹ã‚¯ãŒé«˜ã„

**æ¨å¥¨:**
- ã¾ãšã‚¢ãƒ—ãƒ­ãƒ¼ãƒAã§å®Ÿè£…
- å®‰å®šã—ãŸã‚‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒBã‚’æ¤œè¨

---

### ãƒ•ã‚§ãƒ¼ã‚º4: main.pyçµ±ä¸€åŒ–ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰

ãƒ•ã‚§ãƒ¼ã‚º1ã€œ3ãŒå®Œäº†ã—ãŸå¾Œã€main.pyã‚’çµ±ä¸€åŒ–ã™ã‚‹ã€‚

**å®Ÿæ–½å†…å®¹:**
1. `switch_to()` çµ±ä¸€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…
2. å„`switch_to_*`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ›¸ãæ›ãˆ
3. ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’ç°¡æ½”åŒ–

**å¤‰æ›´ä¾‹:**
```python
# main.py
class GameApplication:
    def __init__(self):
        self.screen = None
        self.current_subsystem: SubsystemBase | None = None
        self.current_mode = "menu"

    def switch_to(self, subsystem: SubsystemBase, mode_name: str):
        """ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ åˆ‡ã‚Šæ›¿ãˆã®çµ±ä¸€ãƒ¡ã‚½ãƒƒãƒ‰"""

        # 1. ç¾åœ¨ã®ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if self.current_subsystem:
            self.current_subsystem.cleanup()
            print(f"ğŸ”‡ {self.current_mode} cleanupå®Œäº†")

        # 2. æ–°ã—ã„ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ
        self.current_subsystem = subsystem
        self.current_mode = mode_name

        # 3. æ–°ã—ã„ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–å‡¦ç†
        self.current_subsystem.on_enter()
        print(f"âœ… {mode_name} ã«åˆ‡ã‚Šæ›¿ãˆ")

    def switch_to_menu(self):
        if not self.main_menu:
            self.main_menu = MainMenu(self.screen)
        self.switch_to(self.main_menu, "menu")

    def switch_to_map(self):
        if not self.map_system:
            self.map_system = AdvancedKimikissMap(self.screen)
        self.switch_to(self.map_system, "map")

    def switch_to_dialogue(self, event_file):
        dialogue = DialogueSubsystem(self.screen, event_file)
        self.switch_to(dialogue, "dialogue")

    def switch_to_home(self):
        if not self.home_module:
            self.home_module = HomeModule(self.screen)
        self.switch_to(self.home_module, "home")

    def run(self):
        """ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—"""
        while self.running:
            events = pygame.event.get()

            # ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
            if self.current_subsystem:
                result = self.current_subsystem.handle_events(events)

                # é·ç§»å‡¦ç†
                if result:
                    self._handle_transition(result)

            # æ›´æ–°
            if self.current_subsystem:
                self.current_subsystem.update()

            # æç”»
            if self.current_subsystem:
                self.current_subsystem.render()

            pygame.display.flip()
            self.clock.tick(30)

    def _handle_transition(self, result: str):
        """é·ç§»çµæœã‚’å‡¦ç†"""
        if result == "go_to_map":
            self.switch_to_map()
        elif result == "go_to_menu":
            self.switch_to_menu()
        elif result == "go_to_home":
            self.switch_to_home()
        elif result.startswith("start_event:"):
            event_id = result.split(":")[1]
            self.switch_to_dialogue(f"events/{event_id}.ks")
        elif result == "dialogue_ended":
            self.mark_current_event_as_completed()
            self.switch_to_map()
        elif result == "quit":
            self.running = False
```

**å‰Šé™¤ã§ãã‚‹ã‚³ãƒ¼ãƒ‰:**
```python
# ã“ã‚Œã‚‰ã®é‡è¤‡ã—ãŸå‡¦ç†ãŒå…¨ã¦ä¸è¦ã«ãªã‚‹
if self.current_mode == "dialogue" and self.dialogue_game_state:
    self.dialogue_game_state['bgm_manager'].stop_bgm()
    self.dialogue_game_state['se_manager'].stop_all_se()

if self.current_mode == "map" and self.map_system:
    self.map_system.bgm_manager.stop_bgm()
```

**å®Œäº†æ¡ä»¶:**
- å…¨ã¦ã®ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ åˆ‡ã‚Šæ›¿ãˆãŒswitch_to()ã‚’çµŒç”±
- é‡è¤‡ã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- éŸ³å£°ãŒé©åˆ‡ã«åœæ­¢ã•ã‚Œã‚‹

---

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### 1. ä¿å®ˆæ€§ã®å‘ä¸Š

**Before:**
```python
# æ–°ã—ã„titleã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
def switch_to_menu():
    if current_mode == "dialogue": ...
    if current_mode == "map": ...
    if current_mode == "title": ...  # â† è¿½åŠ 

def switch_to_home():
    if current_mode == "dialogue": ...
    if current_mode == "map": ...
    if current_mode == "title": ...  # â† è¿½åŠ 

# å…¨ã¦ã®switch_to_*ã«è¿½åŠ ãŒå¿…è¦...
```

**After:**
```python
# TitleScreenSubsystemã‚’ä½œã‚‹ã ã‘
class TitleScreenSubsystem(SubsystemBase):
    def cleanup(self):
        self.bgm_manager.stop_bgm()

# main.pyã¯å¤‰æ›´ä¸è¦ï¼
```

### 2. ãƒã‚°ã®å‰Šæ¸›

- cleanupå¿˜ã‚ŒãŒç™ºç”Ÿã—ãªã„
- å„switch_to_*ã§åŒã˜å‡¦ç†ã‚’æ›¸ãå¿…è¦ãŒãªã„
- ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸€ç®‡æ‰€ã«é›†ç´„ã•ã‚Œã‚‹

### 3. ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã•

```python
def test_map_cleanup():
    map_system = AdvancedKimikissMap(mock_screen)
    map_system.cleanup()
    assert map_system.bgm_manager.current_bgm is None

def test_dialogue_cleanup():
    dialogue = DialogueSubsystem(mock_screen)
    dialogue.cleanup()
    assert dialogue.game_state['bgm_manager'].current_bgm is None
```

### 4. å‹å®‰å…¨æ€§

```python
def switch_to(self, subsystem: SubsystemBase, mode_name: str):
    # type hintsã§å‹ãƒã‚§ãƒƒã‚¯å¯èƒ½
    # IDEã®è£œå®Œã‚‚åŠ¹ã
```

---

## ãƒªã‚¹ã‚¯ç®¡ç†

### ãƒªã‚¹ã‚¯1: dialogueå¤§è¦æ¨¡å¤‰æ›´ã«ã‚ˆã‚‹ä¸å…·åˆ

**å¯¾ç­–:**
- ã‚¢ãƒ—ãƒ­ãƒ¼ãƒAï¼ˆãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰ã‚’æ¡ç”¨
- æ®µéšçš„ã«ç§»è¡Œ
- å„ãƒ•ã‚§ãƒ¼ã‚ºã§ååˆ†ãªãƒ†ã‚¹ãƒˆ

### ãƒªã‚¹ã‚¯2: æ—¢å­˜æ©Ÿèƒ½ã®ç ´å£Š

**å¯¾ç­–:**
- å„ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«å‹•ä½œç¢ºèª
- ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½
- git branchã§ä½œæ¥­

### ãƒªã‚¹ã‚¯3: éåº¦ãªæŠ½è±¡åŒ–

**å¯¾ç­–:**
- å¿…è¦æœ€å°é™ã®æŠ½è±¡åŒ–
- YAGNIã®åŸå‰‡ï¼ˆYou Aren't Gonna Need Itï¼‰
- å®Ÿéš›ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹

---

## ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆç›®å®‰ï¼‰

| ãƒ•ã‚§ãƒ¼ã‚º | ä½œæ¥­å†…å®¹ | è¦‹ç©ã‚‚ã‚Šå·¥æ•° | å„ªå…ˆåº¦ |
|---------|---------|------------|--------|
| ãƒ•ã‚§ãƒ¼ã‚º1 | åŸºåº•ã‚¯ãƒ©ã‚¹ + Menu/Homeç§»è¡Œ | 2-3æ™‚é–“ | é«˜ |
| ãƒ•ã‚§ãƒ¼ã‚º2 | Mapç§»è¡Œ | 1-2æ™‚é–“ | é«˜ |
| ãƒ•ã‚§ãƒ¼ã‚º3 | Dialogueç§»è¡Œï¼ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒAï¼‰ | 3-4æ™‚é–“ | ä¸­ |
| ãƒ•ã‚§ãƒ¼ã‚º4 | main.pyçµ±ä¸€åŒ– | 2-3æ™‚é–“ | é«˜ |
| **åˆè¨ˆ** | | **8-12æ™‚é–“** | |

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ•ã‚§ãƒ¼ã‚º1
- [ ] `subsystem_base.py` ä½œæˆ
- [ ] `MainMenu` ãŒ `SubsystemBase` ã‚’ç¶™æ‰¿
- [ ] `HomeModule` ãŒ `SubsystemBase` ã‚’ç¶™æ‰¿
- [ ] æ—¢å­˜æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹

### ãƒ•ã‚§ãƒ¼ã‚º2
- [ ] `AdvancedKimikissMap` ãŒ `SubsystemBase` ã‚’ç¶™æ‰¿
- [ ] `cleanup()` ã§BGMãŒåœæ­¢ã™ã‚‹
- [ ] `on_enter()` ã§BGMãŒå†ç”Ÿã•ã‚Œã‚‹

### ãƒ•ã‚§ãƒ¼ã‚º3
- [ ] `DialogueSubsystem` ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆèª­ã¿è¾¼ã¿ãŒå‹•ä½œã™ã‚‹
- [ ] `cleanup()` ã§BGMãƒ»SEãŒåœæ­¢ã™ã‚‹
- [ ] æ—¢å­˜ã®dialogueæ©Ÿèƒ½ãŒå…¨ã¦å‹•ä½œã™ã‚‹

### ãƒ•ã‚§ãƒ¼ã‚º4
- [ ] `switch_to()` çµ±ä¸€ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] å…¨ã¦ã®`switch_to_*`ãŒ`switch_to()`ã‚’ä½¿ç”¨
- [ ] é‡è¤‡ã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] éŸ³å£°åœæ­¢ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹

---

## å‚è€ƒè³‡æ–™

- [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ è§£èª¬.md](ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ è§£èª¬.md)
- [dialogue/README.md](../dialogue/README.md)
- [map/README.md](../map/README.md)
- [home/README.md](../home/README.md)
- [menu/README.md](../menu/README.md)

---

## æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | å†…å®¹ | æ‹…å½“ |
|------|------|------|
| 2025-11-23 | åˆç‰ˆä½œæˆ | Claude |
