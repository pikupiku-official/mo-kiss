# KSファイル イベントエディタ

実際の画面、エフェクト、セリフ、音声を**リアルタイムで確認しながら**eventsフォルダのKSファイルを編集できる専用エディタです。

## 特徴

- **左側**: KSファイル一覧 + テキストエディタ
- **右側**: リアルタイムプレビュー（実際のゲーム画面を別ウィンドウで表示）
- **リサイズ可能**: プレビューウィンドウのサイズを自由に変更可能
- **仮想画面**: 1920x1080の仮想画面でレンダリング → ウィンドウサイズに自動スケーリング
- **アスペクト比維持**: ウィンドウをリサイズしても相対位置がズレない
- **ホットリロード**: ファイル保存後、すぐにプレビューに反映
- **音声・エフェクト**: 実際のBGM、SE、背景、キャラクター表示を確認可能

## 使い方

### 1. エディタを起動

```bash
python event_editor.py
```

### 2. 基本的なワークフロー

1. **ファイル選択**
   左側の「KSファイル一覧」から編集したいファイルを選択

2. **プレビュー起動**
   「▶ プレビュー開始」をクリック → 別ウィンドウでPygameプレビューが起動

3. **編集**
   テキストエディタでKSファイルを編集

4. **保存**
   `Ctrl+S` または「💾 保存」ボタンでファイルを保存

5. **リロード**
   `F5` または「🔄 リロード」ボタンでプレビューを更新
   → 編集内容がすぐにプレビューに反映される

### 3. キーボードショートカット

| キー | 機能 |
|------|------|
| `Ctrl+S` | ファイル保存 |
| `F5` | プレビューをリロード（現在の段落位置を保持） |

### 3.5. 段落ジャンプ機能

編集中のイベントで、特定の段落まで一瞬でジャンプできます：

#### 方法1: 段落番号で直接ジャンプ
1. **段落番号を入力**: ツールバーの「段落:」欄に番号を入力（1から開始）
2. **🔍 ジャンプボタンをクリック**: 指定した段落まで即座にジャンプ
3. **現在の段落を確認**: ツールバーの「現在: X」で現在の段落番号を表示

#### 方法2: エディタから右クリック（NEW!）
1. **編集したい箇所を右クリック**: エディタ内の任意の行で右クリック
2. **「🎬 ここからプレビューを開始」を選択**: コンテキストメニューから選択
3. **自動的にその段落からプレビュー開始**: 行番号から段落を自動推定してジャンプ

**使い方の例**：
- イベントの後半を編集する場合、段落100に直接ジャンプ
- セリフを編集中、その行を右クリック → 「ここからプレビューを開始」で即座に確認
- F5でリロードすると、現在の段落位置を保持したままリロード
- 最初から見たい場合は、段落1にジャンプ

**注意**: 段落番号は1から開始します（「」で始まるテキスト行のみカウント）

### 4. プレビューウィンドウの操作

プレビューウィンドウ（Pygameウィンドウ）では、実際のゲームと同じ操作ができます：

| 操作 | 機能 |
|------|------|
| クリック | 次のテキストに進む |
| スペース | 次のテキストに進む |
| Esc | プレビューを閉じる |
| ウィンドウ端をドラッグ | ウィンドウのサイズを変更（アスペクト比は自動調整） |

**ウィンドウリサイズ機能**
- プレビューウィンドウは自由にリサイズ可能
- 仮想画面（1920x1080）でレンダリングされ、ウィンドウサイズに合わせて自動スケーリング
- アスペクト比が維持されるため、UI要素の相対位置がズレない
- 小さくして作業しやすくしたり、大きくして細部を確認したりできます

## 画面構成

```
┌─────────────────────────────────────────────────────┐
│ [ツールバー]                                        │
│ 💾 保存 | 🔄 リロード | ▶ プレビュー開始 | ⏹ 停止 │
├──────────────────┬──────────────────────────────────┤
│ KSファイル一覧   │ プレビュー情報                   │
│ ├ E001.ks        │                                  │
│ ├ E002.ks        │ 使用方法の説明                   │
│ ├ E003.ks        │                                  │
│ └ ...            │                                  │
├══════════════════┤ ← ドラッグでサイズ調整可能       │
│ KSファイル編集   │                                  │
│                  │                                  │
│ [テキストエディタ]                                  │
│                  │                                  │
│ *scene1          │                                  │
│ [bg_show ...]    │                                  │
│ 「セリフ」       │                                  │
│                  │                                  │
└──────────────────┴──────────────────────────────────┘
       ↑
  左右の境界もドラッグでサイズ調整可能

※ プレビューは別ウィンドウで表示
```

### パネルのリサイズ

エディタ内のパネルはすべてリサイズ可能です：

1. **左右のパネル**: 境界線をドラッグして、エディタとプレビュー情報の幅を調整
2. **ファイルリストとエディタ**: 境界線をドラッグして、リストとエディタの高さを調整
3. **プレビューウィンドウ**: ウィンドウの端をドラッグして自由にサイズ変更

デフォルト設定：
- エディタエリアはファイルリストの4倍の高さ
- 編集領域を最大化したい場合は、ファイルリストを小さくできます

## プレビューウィンドウ

プレビューウィンドウは**別スレッド**で動作し、実際のゲームと同じように：

- ✅ 背景画像の表示
- ✅ キャラクター画像の表示
- ✅ テキストの表示
- ✅ 選択肢の表示
- ✅ BGMの再生
- ✅ SEの再生
- ✅ フェード効果
- ✅ キャラクター移動
- ✅ 背景移動

が全て確認できます。

### 仮想画面システム

プレビューウィンドウは**仮想画面システム**を採用しています：

1. **仮想画面（1920x1080）**: ゲームコンテンツは常に1920x1080の仮想画面にレンダリング
2. **自動スケーリング**: 仮想画面をウィンドウサイズに合わせて自動スケーリング
3. **アスペクト比維持**: レターボックス（黒帯）を使ってアスペクト比を保持
4. **座標変換**: マウスクリック位置を仮想座標に自動変換

これにより：
- ウィンドウをどのサイズにしてもUI要素の相対位置がズレない
- 小さいウィンドウで作業効率アップ
- 大きいウィンドウで細部を確認

## 実装の詳細

### アーキテクチャ

- **メインスレッド**: tkinterのGUI（エディタ画面）
- **サブスレッド**: Pygameのプレビューウィンドウ
- **通信**: `queue.Queue`でスレッド間通信

### 仮想画面システムの実装

プレビューウィンドウは2つのサーフェスを使用：

1. **仮想画面 (`virtual_screen`)**: 1920x1080の固定サイズ
   - 全てのゲームコンテンツはこの仮想画面にレンダリング
   - `game_state['screen']`に設定される

2. **実際のウィンドウ (`window`)**: リサイズ可能
   - `pygame.RESIZABLE`フラグで作成
   - デフォルトは960x540（仮想画面の半分）

### スケーリングとレンダリング

```python
# 1. 仮想画面に全てを描画
draw_background(game_state)      # 仮想画面に描画
draw_characters(game_state)      # 仮想画面に描画
# ...

# 2. アスペクト比を保ってスケーリング係数を計算
scale = min(window_width / VIRTUAL_WIDTH, window_height / VIRTUAL_HEIGHT)

# 3. 仮想画面をスケーリングしてウィンドウに描画
scaled_surface = pygame.transform.smoothscale(virtual_screen, (scaled_w, scaled_h))
window.blit(scaled_surface, (offset_x, offset_y))
```

### 座標変換

マウスイベントの座標を仮想座標に変換：

```python
def screen_to_virtual_coords(screen_x, screen_y):
    # スケーリング係数とオフセットを計算
    scale, offset_x, offset_y = get_scale_and_offset()

    # ウィンドウ座標 → 仮想座標
    virtual_x = (screen_x - offset_x) / scale
    virtual_y = (screen_y - offset_y) / scale

    return virtual_x, virtual_y
```

これにより、ウィンドウサイズに関わらず正確なクリック判定が可能になります。

### ファイル構成

```
mo-kiss/
├── event_editor.py          # このエディタのメインファイル
├── events/                  # KSファイルが格納されているフォルダ
│   ├── E001.ks
│   ├── E002.ks
│   └── ...
├── dialogue/                # ダイアログシステム
│   ├── dialogue_loader.py   # KSファイルのパーサー
│   ├── controller2.py       # イベント処理
│   └── ...
└── EVENT_EDITOR_README.md   # このファイル
```

## トラブルシューティング

### プレビューが起動しない

- Pygameが正しくインストールされているか確認
  ```bash
  pip install pygame
  ```

### ファイルが保存できない

- eventsフォルダの書き込み権限を確認
- ファイルが他のプログラムで開かれていないか確認

### リロードしても変更が反映されない

- ファイルが正しく保存されているか確認（Ctrl+S）
- プレビューウィンドウがフリーズしていないか確認
  - フリーズしている場合は一度停止して再起動

### 音声が再生されない

- `bgm/`フォルダと`se/`フォルダに音声ファイルがあるか確認
- Pygameのミキサーが正しく初期化されているか確認

## 制限事項

- デフォルトのウィンドウサイズは960x540（仮想画面の半分）ですが、自由にリサイズ可能です
- 複数のKSファイルを同時にプレビューすることはできません
- プレビュー中に別のファイルを開く場合は、リロードボタンで更新してください
- ウィンドウを極端に小さくすると、テキストが読みづらくなる可能性があります

## 今後の改善案

- [ ] シンタックスハイライト（KSファイルのコマンドを色分け）
- [ ] エラー行のハイライト表示
- [x] プレビューウィンドウのサイズ調整機能（完了）
- [x] 仮想画面システムによるスケーリング対応（完了）
- [x] 段落ジャンプ機能（完了）
- [x] リロード時の段落位置保持（完了）
- [x] DPI awareness対応（完了）
- [x] 右クリックから「ここからプレビューを開始」（完了）
- [ ] 複数ファイルのタブ編集
- [ ] 検索・置換機能
- [ ] Undo/Redo履歴の強化
- [ ] シーン一覧表示（*scene1などのラベルを一覧表示）
- [ ] より正確な段落マッピング（現在は簡易的な推定）

## ライセンス

このエディタはmo-kissプロジェクトの一部として提供されます。

## 問い合わせ

バグ報告や機能要望は、プロジェクトのIssueトラッカーにお願いします。
